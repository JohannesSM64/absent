#!/bin/bash
# Tool for Arch Linux to search a tree of PKGBUILDs and build packages.
# 2010-2014, Johannes Lang√∏y. Public domain.

searchdirs=("/var/abs/core" "/var/abs/extra" "/var/abs/community")
builddir="/tmp/absent-$USER"
mkdir -p "$builddir"

leader=$'\e[1;34m::\e[0m'

function usage {
    echo "absent -- an ABS handler"
    echo "usage: absent [flag] [name]"
    echo "-S: build and install [name]"
    echo "-O: copy [name] to the current directory and fetch sources"
    echo "-Sn: like -S, but with all interactive features disabled"
    echo "-On: idem for -O"
}

function lecho {
    echo "$leader $*"
}

function ask {
    echo -n "$leader $* [Y/n] "
    read -r
    case "$REPLY" in
        (''|[yY]*) return 0 ;;
        (*) return 1 ;;
    esac
}

function find-copy-go {
    name="$1"
    dest="$2"
    unset match
    for dir in "${searchdirs[@]}"; do
        if [[ -d "$dir/$name/" && -f "$dir/$name/PKGBUILD" ]]; then
            match="$dir/$name/"
            break
        fi
    done
    if [[ -z "$match" ]]; then
        lecho "No match found for $name in (${searchdirs[@]})."
        exit 1
    fi
    lecho "$name copied from $dir."
    cp -r "$match" "$dest"
    cd "$dest/$(basename $match)"
}

function interactive {
    if ask "Edit PKGBUILD?"; then
        ${EDITOR:-vi} PKGBUILD
    fi
}

if [[ -z "$2" ]]; then # confirm that we have at least 2 arguments
    usage
    exit
fi

flag="$1"
shift

case "$flag" in
    (-S)
        for i in "$@"; do
            find-copy-go "$i" "$builddir"
            interactive
            makepkg -fsci
            cd ..
        done
        ;;
    (-Sn)
        for i in "$@"; do
            find-copy-go "$i" "$builddir"
            makepkg -fsci --noconfirm
            cd ..
        done
        ;;
    (-O)
        for i in "$@"; do
            find-copy-go "$i" .
            interactive
            makepkg -o
            cd ..
        done
        ;;
    (-On)
        for i in "$@"; do
            find-copy-go "$i" .
            makepkg -o
            cd ..
        done
esac
